<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tesla Dashboard Dark Map</title>

  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { width: 100vw; height: 100vh; filter: brightness(0.85); }

    #destination-input {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      background: #222;
      padding: 8px;
      border-radius: 6px;
      width: 320px;
      box-shadow: 0 0 10px #000;
    }
    #destination-input input {
      width: 100%;
      padding: 6px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }

    #searchResults {
      max-height: 250px;
      overflow-y: auto;
      background: #111;
      margin-top: 4px;
      border-radius: 6px;
      color: white;
      box-shadow: 0 0 10px #000;
    }

    .search-result {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid #333;
      cursor: pointer;
    }
    .search-result:hover {
      background: #333;
    }
    .search-result button {
      background: #00FF00;
      border: none;
      color: #000;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    #etaDisplay {
      position: fixed;
      bottom: 60px;
      right: 20px;
      background: #222;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      z-index: 1001;
      display: none;
      font-family: monospace;
    }

    #bottom-buttons {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #111;
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 1001;
    }
    #bottom-buttons button {
      color: white;
      background: transparent;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="destination-input">
    <input type="text" id="destination" placeholder="Search destination..." autocomplete="off" />
    <div id="searchResults" style="display:none;"></div>
  </div>

  <div id="etaDisplay">ETA:</div>

  <div id="bottom-buttons">
    <button>Home</button>
    <button>Music</button>
    <button>Navigation</button>
  </div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    let map, userMarker, userLocation = null, destinationCoords = null;
    let routeSourceId = "route-line";
    let routeInterval = null;

    map = new maplibregl.Map({
      container: 'map',
      style: 'https://api.maptiler.com/maps/dark-matter/style.json?key=FznQNgpoDlBPTioAaIs3',
      center: [-95.3698, 29.7604],
      zoom: 13
    });

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        userLocation = [pos.coords.latitude, pos.coords.longitude];
        const coords = [pos.coords.longitude, pos.coords.latitude];
        if (!userMarker) {
          userMarker = new maplibregl.Marker({ color: "#00FF00" }).setLngLat(coords).addTo(map);
        } else {
          userMarker.setLngLat(coords);
        }
      }, err => {
        console.warn('Geolocation error:', err);
      }, { enableHighAccuracy: true });
    } else {
      alert("Geolocation not supported");
    }

    function decodePolyline(encoded) {
      const coords = [];
      let index = 0, lat = 0, lng = 0;

      while (index < encoded.length) {
        let result = 1, shift = 0, b;
        do {
          b = encoded.charCodeAt(index++) - 63 - 1;
          result += b << shift;
          shift += 5;
        } while (b >= 0x1f);
        lat += (result & 1) ? ~(result >> 1) : (result >> 1);

        result = 1; shift = 0;
        do {
          b = encoded.charCodeAt(index++) - 63 - 1;
          result += b << shift;
          shift += 5;
        } while (b >= 0x1f);
        lng += (result & 1) ? ~(result >> 1) : (result >> 1);

        coords.push([lng * 1e-5, lat * 1e-5]);
      }
      return coords;
    }

    function drawRoute(coords) {
      if (map.getSource(routeSourceId)) {
        map.removeLayer(routeSourceId);
        map.removeSource(routeSourceId);
      }
      map.addSource(routeSourceId, {
        type: 'geojson',
        data: {
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: coords
          }
        }
      });
      map.addLayer({
        id: routeSourceId,
        type: 'line',
        source: routeSourceId,
        layout: { 'line-join': 'round', 'line-cap': 'round' },
        paint: {
          'line-color': '#00FF00',
          'line-width': 5
        }
      });
    }

    function showETA(seconds) {
      const etaDisplay = document.getElementById("etaDisplay");
      const mins = Math.round(seconds / 60);
      etaDisplay.innerText = `ETA: ${mins} min`;
      etaDisplay.style.display = 'block';
    }

    function fetchRoute() {
      if (!userLocation || !destinationCoords) return;

      const body = {
        locations: [
          { lat: userLocation[0], lon: userLocation[1] },
          { lat: destinationCoords[0], lon: destinationCoords[1] }
        ],
        costing: "auto",
        directions_options: { units: "miles" }
      };

      fetch(`https://valhalla1.openstreetmap.de/route?json=${encodeURIComponent(JSON.stringify(body))}`)
        .then(res => res.json())
        .then(data => {
          if (!data.trip || !data.trip.legs.length) return alert("Route error");
          const coords = decodePolyline(data.trip.legs[0].shape);
          drawRoute(coords);
          showETA(data.trip.summary.time);
        })
        .catch(() => alert("Routing failed"));
    }

    function startAutoRouting() {
      if (routeInterval) clearInterval(routeInterval);
      routeInterval = setInterval(fetchRoute, 10000); // every 10 seconds
    }

    const input = document.getElementById('destination');
    const resultsDiv = document.getElementById('searchResults');

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    let searchTimeout = null;
    input.addEventListener('input', () => {
      const query = input.value.trim();
      if (!query || !userLocation) {
        resultsDiv.style.display = 'none';
        resultsDiv.innerHTML = '';
        return;
      }

      if (searchTimeout) clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=10&lat=${userLocation[0]}&lon=${userLocation[1]}`)
          .then(res => res.json())
          .then(data => {
            if (!data.features || data.features.length === 0) {
              resultsDiv.style.display = 'none';
              resultsDiv.innerHTML = '';
              return;
            }

            const sorted = data.features.sort((a,b) => {
              const distA = getDistance(userLocation[0], userLocation[1], a.geometry.coordinates[1], a.geometry.coordinates[0]);
              const distB = getDistance(userLocation[0], userLocation[1], b.geometry.coordinates[1], b.geometry.coordinates[0]);
              return distA - distB;
            });

            resultsDiv.innerHTML = '';
            sorted.forEach(feature => {
              const name = feature.properties.name || feature.properties.street || "Unknown";
              const city = feature.properties.city || feature.properties.state || "";
              const displayName = city ? `${name}, ${city}` : name;
              const [lon, lat] = feature.geometry.coordinates;

              const div = document.createElement('div');
              div.className = 'search-result';

              const span = document.createElement('span');
              span.textContent = displayName;

              const btn = document.createElement('button');
              btn.textContent = 'Go';
              btn.onclick = (e) => {
                e.stopPropagation();
                resultsDiv.style.display = 'none';
                input.value = displayName;
                destinationCoords = [lat, lon];
                fetchRoute();
                startAutoRouting();
              };

              div.appendChild(span);
              div.appendChild(btn);
              resultsDiv.appendChild(div);
            });
            resultsDiv.style.display = 'block';
          });
      }, 300);
    });

    document.addEventListener('click', (e) => {
      if (!document.getElementById("destination-input").contains(e.target)) {
        resultsDiv.style.display = 'none';
      }
    });
  </script>
</body>
</html>
