<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Tesla Dashboard v6</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      background-color: #000;
      font-family: sans-serif;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -webkit-overflow-scrolling: touch;
      color: white;
      overflow: hidden;
    }
    body {
      padding-top: env(safe-area-inset-top);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
    }

    #map {
      height: 100vh;
      width: 100vw;
      background-color: #000;
    }
    #destination-input {
      position: absolute;
      top: calc(env(safe-area-inset-top) + 10px);
      left: 10px;
      right: 10px;
      max-width: 350px;
      margin: 0 auto;
      background: #222;
      padding: 10px;
      border-radius: 6px;
      z-index: 10;
      box-shadow: 0 0 15px #000;
      box-sizing: border-box;
    }
    #destination-input input {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      background: #111;
      color: white;
      outline: none;
    }
    #searchResults {
      max-height: 300px;
      overflow-y: auto;
      background: #111;
      color: white;
      border-radius: 6px;
      display: none;
      margin-top: 4px;
      box-shadow: 0 0 10px #000;
    }
    .search-result {
      padding: 8px;
      border-bottom: 1px solid #333;
      cursor: pointer;
      user-select: none;
    }
    .search-result:hover {
      background: #333;
    }
    #etaDisplay {
      position: fixed;
      bottom: 60px;
      right: 20px;
      background: #222;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      z-index: 1001;
      display: none;
      font-family: monospace;
      user-select: none;
      box-shadow: 0 0 10px #000;
    }
    #stopBtn {
      position: fixed;
      bottom: 110px;
      right: 20px;
      background: #900;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 1001;
      display: none;
      user-select: none;
      box-shadow: 0 0 10px #000;
    }
    #bottom-buttons {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #111;
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 1001;
      user-select: none;
      box-shadow: 0 -2px 5px #000;
    }
    #bottom-buttons button {
      color: white;
      background: transparent;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }
    #recenterBtn {
      position: absolute;
      bottom: 160px;
      left: 20px;
      z-index: 20;
      background: #000;
      color: #0f0;
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 0 10px #000;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="destination-input">
    <input type="text" id="destination" placeholder="Search destination..." autocomplete="off" />
    <div id="searchResults"></div>
  </div>

  <button id="recenterBtn">Recenter</button>
  <button id="stopBtn">Stop</button>
  <div id="etaDisplay">ETA:</div>

  <div id="bottom-buttons">
    <button>Home</button>
    <button>Music</button>
    <button>Navigation</button>
  </div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDNIMK5n09eQactHuhsqzZomcj-0Gyv_NA&libraries=places"></script>
  <script>
    let map;
    let userMarker;
    let directionsService;
    let directionsRenderer;
    let userLocation = null;
    let autoRecenter = true;
    let routingActive = false;
    let currentHeading = 0;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 15,
        disableDefaultUI: true,
        tilt: 45,
        heading: 0,
        styles: [
          { elementType: "geometry", stylers: [{ color: "#212121" }] },
          { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#ffffff" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#000000" }] },
          {
            featureType: "administrative",
            elementType: "geometry",
            stylers: [{ color: "#757575" }],
          },
          {
            featureType: "poi",
            elementType: "geometry",
            stylers: [{ color: "#1f1f1f" }],
          },
          {
            featureType: "road",
            elementType: "geometry",
            stylers: [{ color: "#383838" }],
          },
          {
            featureType: "transit",
            elementType: "geometry",
            stylers: [{ color: "#2f2f2f" }],
          },
          {
            featureType: "water",
            elementType: "geometry",
            stylers: [{ color: "#000000" }],
          },
        ],
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });

      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (position) => {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            if (!userMarker) {
              userMarker = new google.maps.Marker({
                position: userLocation,
                map,
                icon: getTeslaArrowIcon(0),
                anchorPoint: new google.maps.Point(12, 12),
              });
              map.setCenter(userLocation);
            } else {
              userMarker.setPosition(userLocation);
            }

            if (routingActive) {
              // Rotate map and marker
              map.setHeading(currentHeading);
              map.setCenter(userLocation);
              userMarker.setIcon(getTeslaArrowIcon(currentHeading));
            } else if (autoRecenter) {
              map.setHeading(0);
              map.setCenter(userLocation);
              userMarker.setIcon(getTeslaArrowIcon(0));
            }
          },
          (err) => {
            console.error("Geolocation error:", err);
          },
          { enableHighAccuracy: true, maximumAge: 3000, timeout: 7000 }
        );
      }

      // Device orientation (for heading)
      if (window.DeviceOrientationEvent) {
        window.addEventListener("deviceorientationabsolute", (event) => {
          if (event.absolute && event.alpha !== null) {
            currentHeading = 360 - event.alpha; // Convert to compass heading
            if (routingActive) {
              map.setHeading(currentHeading);
              map.setCenter(userLocation);
              if (userMarker) userMarker.setIcon(getTeslaArrowIcon(currentHeading));
            }
          }
        });
      }

      const input = document.getElementById("destination");
      const searchBox = new google.maps.places.SearchBox(input);
      const resultsDiv = document.getElementById("searchResults");
      const stopBtn = document.getElementById("stopBtn");
      const etaDisplay = document.getElementById("etaDisplay");

      input.addEventListener("input", () => {
        resultsDiv.innerHTML = "";
        resultsDiv.style.display = "none";
      });

      searchBox.addListener("places_changed", () => {
        const places = searchBox.getPlaces();
        resultsDiv.innerHTML = "";

        if (places.length === 0) return;

        places.forEach((place) => {
          if (!place.geometry) return;

          const resultItem = document.createElement("div");
          resultItem.className = "search-result";
          resultItem.textContent = place.name;
          resultItem.addEventListener("click", () => {
            input.value = place.name;
            resultsDiv.innerHTML = "";
            resultsDiv.style.display = "none";
            routeTo(place.geometry.location);
          });

          resultsDiv.appendChild(resultItem);
        });

        resultsDiv.style.display = "block";
      });

      document.addEventListener("click", (e) => {
        if (!document.getElementById("destination-input").contains(e.target)) {
          resultsDiv.style.display = "none";
        }
      });

      document.getElementById("recenterBtn").addEventListener("click", () => {
        if (userLocation) {
          autoRecenter = true;
          routingActive = false;
          map.setHeading(0);
          map.setCenter(userLocation);
          userMarker.setIcon(getTeslaArrowIcon(0));
        }
      });

      stopBtn.addEventListener("click", () => {
        directionsRenderer.set("directions", null);
        etaDisplay.style.display = "none";
        stopBtn.style.display = "none";
        autoRecenter = true;
        routingActive = false;
        map.setHeading(0);
        if (userLocation) {
          map.setCenter(userLocation);
          userMarker.setIcon(getTeslaArrowIcon(0));
        }
      });
    }

    function getTeslaArrowIcon(rotationDegrees) {
      // Rounded, wider Tesla style arrow with white stroke and shadow
      const svg = `
        <svg width="40" height="40" viewBox="0 0 24 24" 
          xmlns="http://www.w3.org/2000/svg" 
          style="filter: drop-shadow(0 0 2px rgba(0,0,0,0.8));">
          <path d="M12 2 L18 14 L12 11 L6 14 Z" 
            fill="red" stroke="white" stroke-width="1.5" stroke-linejoin="round" />
        </svg>
      `;

      return {
        url: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg),
        anchor: new google.maps.Point(12, 12),
        scaledSize: new google.maps.Size(24, 24),
        rotation: rotationDegrees,
      };
    }

    function routeTo(destination) {
      if (!userLocation) {
        alert("Waiting for location...");
        return;
      }

      autoRecenter = false;
      routingActive = true;

      directionsService.route(
        {
          origin: userLocation,
          destination: destination,
          travelMode: "DRIVING",
        },
        (response, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(response);
            const duration = response.routes[0].legs[0].duration.text;
            document.getElementById("etaDisplay").innerText = "ETA: " + duration;
            document.getElementById("etaDisplay").style.display = "block";
            document.getElementById("stopBtn").style.display = "block";
          } else {
            alert("Directions request failed: " + status);
          }
        }
      );
    }

    window.initMap = initMap;
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDNIMK5n09eQactHuhsqzZomcj-0Gyv_NA&libraries=places&callback=initMap">
  </script>
</body>
</html>
